!function(){var a=angular.module("holdemApp",["ngRoute","ngAnimate","holdemFilters","holdemControllers","holdemServices","holdemDirectives","holdemConstants"]);a.config(["$routeProvider","$locationProvider",function(a,b){a.when("/game",{templateUrl:"/partials/game",controller:"GameCtrl"}).otherwise({redirectTo:"/game"}),b.html5Mode(!0)}])}(window),function(){var a=angular.module("holdemControllers",[]);a.controller("GameCtrl",["$scope","gameService","uiService","HOLDEM_EVENTS",function(a,b,c,d){a.gameStarted=!1,a.handNr=null,a.addPlayer=function(){c.promptForInput("Player name","Add player","Cancel",function(c,d){c&&(b.addPlayer({name:d,stack:1500}),a.players=b.players)})},a.startGame=function(){b.startGame()},a.nextHand=function(){b.nextHand()},a.advanceBettingRound=function(){b.advanceBettingRound()},a.$on(d.GAME_STARTED,function(){a.gameStarted=!0}),a.$on(d.NEXT_HAND_DEALT,function(b,c){a.handNr=c}),a.$on(d.BETTING_ROUND_ADVANCED,function(b,c){a.currentBettingRound=c})}])}(window),function(){var a=angular.module("holdemDirectives",[]);a.directive("playerPanel",[function(){return{restrict:"E",templateUrl:"/partials/player-panel",replace:!0,scope:{seatNr:"=seatNr"},controller:["$scope","$timeout","gameService","HOLDEM_EVENTS",function(a,b,c,d){function e(a){var b=a[g];f(b)}function f(c){b(function(){a.player=c})}var g=a.seatNr-1;a.isDealer=!1,a.isSmallBlind=!1,a.isBigBlind=!1,a.deletePlayer=function(){c.deletePlayer(g)},a.isGameStarted=function(){return c.gameStarted},a.$on(d.PLAYER_ADDED,function(a,b){e(b)}),a.$on(d.PLAYER_DELETED,function(a,b){e(b)}),a.$on(d.ROLES_ASSIGNED,function(b,c){a.isDealer=g===c.dealer,a.isSmallBlind=g===c.smallBlind,a.isBigBlind=g===c.bigBlind}),a.$on(d.ACTION_PERFORMED,function(b,c){c.player===g&&(a.mostRecentAction=c)}),a.$on(d.TURN_ASSIGNED,function(a,b){b===g&&console.log("It is our player's turn ("+b+")")})}]}}])}(window),function(){var a=angular.module("holdemFilters",[]);a.filter("stackSize",[function(){return function(a){return"number"==typeof a?"Stack size: "+a:void 0}}]),a.filter("handNrFilter",[function(){return function(a){return"number"==typeof a?"Hand #"+a:void 0}}]),a.filter("playerAction",[function(){return function(a){return a?a.action+" "+a.amount:void 0}}]),a.filter("bettingRound",["HOLDEM_BETTING_ROUNDS",function(a){return function(b){if(b){var c;switch(b){case a.PRE_FLOP:c="PRE-FLOP";break;case a.FLOP:c="FLOP";break;case a.TURN:c="TURN";break;case a.RIVER:c="RIVER";break;default:throw"Illegal betting round"}return"Current betting round: "+c}}}])}(window),function(a,b){var c=angular.module("holdemServices",[]);c.service("gameService",["$rootScope","HOLDEM_EVENTS","HOLDEM_ACTIONS","HOLDEM_BETTING_ROUNDS",function(a,c,d,e){function f(){var b=w.getCurrentHand(),d=w.getPreviousHand();b.roles=d?{dealer:(d.roles.dealer+1)%w.players.length,smallBlind:(d.roles.smallBlind+1)%w.players.length,bigBlind:(d.roles.bigBlind+1)%w.players.length}:w.players.length>2?{dealer:0,smallBlind:1,bigBlind:2}:{dealer:0,smallBlind:0,bigBlind:1},a.$broadcast(c.ROLES_ASSIGNED,b.roles)}function g(d){if(d)return w.whoseTurnItIs=i(),void a.$broadcast(c.TURN_ASSIGNED,w.whoseTurnItIs);if(w.isCurrentBettingRoundFinished())w.whoseTurnItIs=b;else{var e=w.getLastAction().player;w.whoseTurnItIs=j(e,!1),a.$broadcast(c.TURN_ASSIGNED,w.whoseTurnItIs)}}function h(){var a=w.getCurrentHand(),b={player:a.roles.smallBlind,action:d.BET,amount:a.blinds.smallBlind},c={player:a.roles.bigBlind,action:d.RAISE,amount:a.blinds.bigBlind};w.recordAction(b,!0),w.recordAction(c)}function i(){var a=w.getCurrentHand(),b=a.roles.smallBlind;return j(b,!0)}function j(a,b){for(var c,d=b?0:1,e=w.getCurrentHand(),f=a+d;f<a+w.players.length;f++)if(c=f%w.players.length,!w.isPlayerFinished(c)&&e.foldedPlayers.indexOf(c)<0)return c;throw"No unfinished player found"}function k(a){for(var b=w.getCurrentHand().actions,c=[],d=0;d<b.length;d++)b[d].bettingRound===w.currentBettingRound&&(a?Array.isArray(a)?a.indexOf(b[d].action)>-1&&c.push(b[d]):b[d].action===a&&c.push(b[d]):c.push(b[d]));return c}function l(a){for(var b,c={},e=0;e<a.length;e++)b=a[e],b.action===d.FOLD?delete c[b.player]:b.action===d.CHECK?c[b.player]=0:c.hasOwnProperty(b.player)?c[b.player]+=b.amount:c[b.player]=b.amount;return c}function m(a){var b,c;for(var d in a)a.hasOwnProperty(d)&&(c=a[d],(!b||c>b.amount)&&(b={player:d,amount:c}));return b}function n(a,b){for(var c=[],d=0;d<w.players.length;d++)a.commitments.hasOwnProperty(d)&&b.indexOf(d)<0&&c.indexOf(a.commitments[d])<0&&c.push(a.commitments[d]);return c}function o(a){if(a.action!==d.CALL)return!1;var b=l(k()),c=m(b);if(a.player==c.player)return!1;var e=b[a.player]||0;return w.players[a.player].stack===a.amount?!0:a.amount==c.amount-e?!0:!1}function p(a,b){if(a.action!==d.BET)return!1;var c=l(k()),e=m(c);return e&&0!==e.amount?!1:a.amount>=w.getCurrentHand().blinds.bigBlind?a.amount<=w.players[a.player].stack:b?a.player===w.getCurrentHand().roles.smallBlind:a.amount===w.players[a.player].stack}function q(a){if(a.action!==d.RAISE)return!1;var b=k([d.BET,d.RAISE]),c=l(k());if(!(b.length>0))return!1;if(a.amount===w.players[a.player].stack){var e=b[b.length-1],f=c[e.player],g=c[a.player]+a.amount;return g>f}if(1===b.length){if(a.amount>=2*b[0].amount&&a.amount<=w.players[a.player].stack)return!0}else if(b.length>1){var h=b[b.length-1],i=b[b.length-2],j=c[h.player],m=c[i.player],n=j-m,o=(c[a.player]||0)+a.amount,p=o-j;return p>=n}return!1}function r(a){if(a.action!==d.CHECK)return!1;var b=l(k()),c=m(b);return c&&0!==c.amount?!1:!0}function s(b,d){w.players[b].stack+=d,a.$broadcast(c.PLAYER_WON_MONEY,{player:b,amount:d})}function t(){u(),v()}function u(){for(var b=0;b<w.players.length;b++)w.finishedPlayers.indexOf(b)<0&&0===w.players[b].stack&&(w.finishedPlayers.push(b),a.$broadcast(c.PLAYER_FINISHED,b))}function v(){if(w.players.length-w.finishedPlayers.length===1){for(var b=[],d=0;d<w.players.length;d++)w.finishedPlayers.indexOf(d)<0&&b.push(d);if(1!==b.length)throw"More or less than one player left despite array lengths indicate there should only be one.";a.$broadcast(c.PLAYER_WON_TOURNAMENT,b[0])}}var w=this;this.players=[],this.finishedPlayers=[],this.allHands=[],this.gameStarted=!1,this.currentBettingRound=null,this.whoseTurnItIs=b,this.addPlayer=function(b){return this.gameStarted?!1:(b.name=b.name||"Player "+(this.players.length+1),b.stack=b.stack||1500,this.players.push(b),void a.$broadcast(c.PLAYER_ADDED,this.players))},this.deletePlayer=function(b){return this.gameStarted?!1:(this.players.splice(b,1),void a.$broadcast(c.PLAYER_DELETED,this.players))},this.isPlayerFinished=function(a){return this.finishedPlayers.indexOf(a)>-1},this.startGame=function(){this.gameStarted=!0,this.currentBettingRound=e.PRE_FLOP,a.$broadcast(c.GAME_STARTED),this.nextHand()},this.nextHand=function(){var b=this.allHands.length+1,d={};this.currentBettingRound=e.PRE_FLOP;for(var g=0;g<this.players.length;g++)this.finishedPlayers.indexOf(g)<0&&(d[g]=0);var i={amount:0,commitments:d};this.allHands.push({handNr:b,blinds:{smallBlind:10,bigBlind:20},foldedPlayers:[],actions:[],pot:i}),f(),w.whoseTurnItIs=this.getCurrentHand().roles.smallBlind,h(),a.$broadcast(c.NEXT_HAND_DEALT,b),a.$broadcast(c.BETTING_ROUND_ADVANCED,this.currentBettingRound)},this.advanceBettingRound=function(){if(!this.isCurrentBettingRoundFinished())throw"Current betting round wasn't yet finished";switch(this.currentBettingRound){case e.PRE_FLOP:this.currentBettingRound=e.FLOP;break;case e.FLOP:this.currentBettingRound=e.TURN;break;case e.TURN:this.currentBettingRound=e.RIVER;break;case e.RIVER:throw"There is no betting round after the river"}a.$broadcast(c.BETTING_ROUND_ADVANCED,this.currentBettingRound),g(!0)},this.getCurrentHand=function(){return this.allHands.length<1?null:this.allHands[this.allHands.length-1]},this.getPreviousHand=function(){return this.allHands.length<2?null:this.allHands[this.allHands.length-2]},this.recordAction=function(b,e){if(!this.doesHandRequireMoreAction()||this.isCurrentBettingRoundFinished())throw"No more action required in this hand or betting round";if(!b.hasOwnProperty("player")||!b.action)throw"No player or action given";if(b.player!==this.whoseTurnItIs)throw"Player acted out of turn";if(b.action!==d.FOLD&&b.action!==d.CHECK&&!b.hasOwnProperty("amount"))throw"No amount given in a non-fold/check action";var f=this.getCurrentHand();if(b.action===d.FOLD)f.foldedPlayers.push(b.player);else if(b.action===d.CALL){if(!o(b))throw"Invalid call"}else if(b.action===d.BET){if(!p(b,e))throw"Invalid bet"}else if(b.action===d.RAISE){if(!q(b))throw"Invalid raise"}else if(b.action===d.CHECK&&!r(b))throw"Invalid check";b.hasOwnProperty("amount")&&(this.players[b.player].stack-=b.amount,f.pot.amount+=b.amount,f.pot.commitments[b.player]+=b.amount),b.bettingRound=this.currentBettingRound,f.actions.push(b),a.$broadcast(c.ACTION_PERFORMED,b),g()},this.isCurrentBettingRoundFinished=function(){var a=k(),b=this.players.length-this.getCurrentHand().foldedPlayers.length;if(a.length<b)return!1;for(var c=l(a),d=m(c),e=0;e<this.players.length;e++)if(c.hasOwnProperty(e)&&0!==this.players[e].stack&&c[e]!==d.amount)return!1;return!0},this.getLastAction=function(){var a=w.getCurrentHand();if(!a.actions||!a.actions.length)throw"No actions yet in current hand";return a.actions[a.actions.length-1]},this.doesHandRequireMoreAction=function(){if(!this.isCurrentBettingRoundFinished())return!0;var a=this.players.reduce(function(a,b,c){return w.getCurrentHand().foldedPlayers.indexOf(c)<0&&a.push(c),a},[]);if(a.length<2)return!1;for(var b=0,c=0;c<a.length;c++)if(this.players[a[c]].stack>0&&b++,b>=2)return!0;return!1},this.doesHandRequireShowdown=function(){if(this.doesHandRequireMoreAction())return!1;var a=this.players.length-this.finishedPlayers.length,b=a-this.getCurrentHand().foldedPlayers.length;return b>=2},this.resolveCurrentHandByShowdown=function(a){if(this.doesHandRequireMoreAction())throw"Hand requires more action";if(!this.doesHandRequireShowdown())throw"Hand requires no showdown";for(var b=this.convertToSidePots(this.getCurrentHand().pot),c=[],d=0;d<b.length;d++){for(var e=b[d].eligiblePlayers,f=!1,g=0;g<a.length;g++)if(!f)if(Array.isArray(a[g])){for(var h=a[g],i=[],j=0;j<h.length;j++)e.indexOf(h[j])&&i.push(h[j]);if(i.length>0){for(var k=b[d].amount/i.length,l=0;l<i.length;l++)c.push({player:i[l],amount:k});f=!0}}else{var m=a[g];e.indexOf(m)>=0&&(c.push({player:m,amount:b[d].amount}),f=!0)}if(!f)throw"Insufficient ranking. Side pot #"+d+" could not be paid out."}this.getCurrentHand().payments=c;for(var n=0;n<c.length;n++){var o=c[n];s(o.player,o.amount)}t()},this.resolveCurrentHandWithoutShowdown=function(){if(this.doesHandRequireMoreAction())throw"Hand requires more action";if(this.doesHandRequireShowdown())throw"Hand requires showdown";for(var a=[],b=0;b<this.players.length;b++)this.finishedPlayers.indexOf(b)<0&&this.getCurrentHand().foldedPlayers.indexOf(b)<0&&a.push(b);if(1!==a.length)throw"Zero or more than one player have not folded, cannot resolve hand";for(var c=a[0],d=this.convertToSidePots(this.getCurrentHand().pot),e=[],f=0;f<d.length;f++){var g=d[f];if(g.eligiblePlayers.indexOf(c)<0)throw"Only non-folded player does not appear in eligible players";e.push({player:c,amount:g.amount})}for(var h=0;h<e.length;h++){var i=e[h];s(i.player,i.amount)}t()},this.convertToSidePots=function(a){var b=this.getCurrentHand().foldedPlayers,c=n(a,b);c.push(0);var d=c.length-1;c.sort(function(a,b){return a-b});for(var e=[],f=0;d>f;f++)e.push({amount:0,eligiblePlayers:[]});for(var g=0;d>g;g++)for(var h=0;h<this.players.length;h++)a.commitments.hasOwnProperty(h)&&(e[g].amount+=Math.max(Math.min(a.commitments[h],c[g+1]),0)-c[g],b.indexOf(h)<0&&a.commitments[h]>c[g]&&e[g].eligiblePlayers.push(h));return e}}]),c.factory("uiService",[function(){return{successMessage:function(a){alertify.success(a)},errorMessage:function(a){alertify.error(a)},infoMessage:function(a){alertify.info(a)},promptForInput:function(a,b,c,d){alertify.set({labels:{ok:b,cancel:c}}),alertify.prompt(a,d)}}}])}(window),function(){var a=angular.module("holdemConstants",[]);a.constant("HOLDEM_EVENTS",{GAME_STARTED:"gameStarted",PLAYER_ADDED:"playerAdded",PLAYER_DELETED:"playerDeleted",NEXT_HAND_DEALT:"nextHandDealt",ROLES_ASSIGNED:"rolesAssigned",ACTION_PERFORMED:"actionPerformed",BETTING_ROUND_ADVANCED:"bettingRoundAdvanced",TURN_ASSIGNED:"turnAssigned",PLAYER_WON_MONEY:"playerWonMoney",PLAYER_FINISHED:"playerFinished",PLAYER_WON_TOURNAMENT:"playerWonTournament"}),a.constant("HOLDEM_ACTIONS",{FOLD:"fold",CALL:"call",RAISE:"raise",BET:"bet",CHECK:"check"}),a.constant("HOLDEM_BETTING_ROUNDS",{PRE_FLOP:"pre_flop",FLOP:"flop",TURN:"turn",RIVER:"river"})}(window);
//# sourceMappingURL=holdemApp.min.js.map